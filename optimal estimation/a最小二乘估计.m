%估计直线
H=[1,1;1,2;1,3;1,4;1,5;1,6];
D=[0.25,0,0,0,0,0;0,0.16,0,0,0,0;0,0,0.16,0,0,0;0,0,0,0.25,0,0;0,0,0,0,0.25,0;0,0,0,0,0,0.25];
Z=[4.16;4.52;5.04;6.78;9.18;9.26];
I=eye(6);
X=inv(H'/D*H)*H'*inv(D)*Z;
V1=inv(H'/D*H)%验前精度I
v=(H/(H'/D*H)*H'/D-I)*Z;
W=inv(D);
t=v'*W*v
a=t/(6-2)
V2=(inv(H'/D*H))*a%????

%高差
H=[1,0;-1,0;-1,1;0,1;0,1];
D=[3.5 2.7 4.0 3.0 2.5];
a0=1000;
W=a0*inv(diag(D));
I=eye(5);
Z=[5.84+237.483;3.79-247.12;-3.58;2.26+237.483;-7.37+247.12];
X=inv(H'*W*H)*H'*W*Z;
V1=inv(H'/diag(D)*H)
%v=(H/(H'*W*H)*H'*W-I)*Z;
v=H*X-Z;
t=(v'*W)*v;
a=t/(5-2);
V2=(inv(H'*W*H))*a
Vh3=[-1 1]*V2*[-1;1];

%%2.1
H=[1,0;0,1;1,0;0,1];
D=eye(4);
Z=[0.83;0.24;0.833;0.245];
x=inv(H'/D*H)*H'/D*Z;
X=[50;30]+x;
V1=inv(H'/D*H)
v=(H/(H'/D*H)*H'/D-D)*Z;
t=v'/D*v;
a=t/2;
V2=a*inv(H'/D*H)
Z1=[50.83;30.24;50.833;30.245];
X1=inv(H'/D*H)*H'/D*Z1;
v1=(H/(H'/D*H)*H'/D-D)*Z1;
a1=(v1'/D*v1)/2;
%估计面积
S=[50.83*30.24;50.83*30.245;50.833*30.24;50.833*30.245];
H=[1;1;1;1];
D=eye(4);
X2=inv(H'/D*H)*H'/D*S;
V2=inv(H'/D*H);
sum=0;
for i=1:4
    sum=sum+(S(i)-X2)^2;
end
v2=sum/4;
v3=(H/(H'/D*H)*H'/D-D)*S;
a2=(v3'/D*v3)/3;
V3=V2*a2;


%%2.2
H=[1,-5,25;1,-3,9;1,-1,1;1,1,1;1,3,9];
D=eye(5);
Z=[0;-2;0;3;10];
I=eye(5);
v=(H/(H'/D*H)*H'/D-I)*Z;
a=(v'/D*v)/2
X=inv(H'/D*H)*H'*inv(D)*Z;
V1=inv(H'/D*H)
V2=V1*a
y5=[1 3 9]*X;
Vy5=[1 3 9]*V2*[1;3;9];
%含约束条件
C=[1,0,-1];
p=0;
H=[1,-5,25;1,-3,9;1,-1,1;1,1,1;1,3,9];
W=eye(5);
z=[0;-2;0;3;10];
I=eye(5);
N=H'*W*H;
Nc=C/N*C';
x=(inv(N)-inv(N)*C'/Nc*C/N)*H'*W*z-inv(N)*C'/Nc*p;
K=inv(Nc)*(C/N*H'*W*z+p);
v=H*x-z;
a=v'*W*v/3;
V1=inv(N)-inv(N)*C'/Nc*C/N;
V2=a*V1;

%P17
X=[14;14];
d=[0.05^2 0.05^2 0.05^2];
D=diag(d);
I=eye(3);
for i=1:1
    H=[X(1)/sqrt(X(1)^2+(X(2)-10)^2),(X(2)-10)/sqrt(X(1)^2+(X(2)-10)^2);X(1)/sqrt((X(1)-0)^2+(X(2)-0)^2),X(2)/sqrt((X(1)-0)^2+(X(2)-0)^2);(X(1)-10)/sqrt(X(2)*X(2)+(X(1)-10)*(X(1)-10)),X(2)/sqrt(X(2)*X(2)+(X(1)-10)*(X(1)-10))];
    Z=[15.84-sqrt(X(1,1)*X(1,1)+(X(2,1)-10)*(X(2,1)-10));21.3-sqrt((X(1)-0)^2+(X(2)-0)^2);15.85-sqrt(X(2,1)*X(2,1)+(X(1,1)-10)*(X(1,1)-10))];
    x=inv(H'/D*H)*H'/D*Z;
    X1=X+x;
    X=X1;
end
v=(H/(H'/D*H)*H'/D-I)*Z;
a=(v'/D*v)/1;
V1=inv(H'/D*H)
V2=V1*a
d=[0.05^2 0.05^2 0.05^2];
D=diag(d);
I=eye(3);
H=[14/sqrt(196+16),4/sqrt(196+16);1/sqrt(2),1/sqrt(2);4/sqrt(196+16),14/sqrt(196+16)];
Z=[15.84-sqrt(196+16);21.3-14*sqrt(2);15.85-sqrt(196+16)];
x=inv(H'/D*H)*H'/D*Z;
X=[14;14];
X1=X+x;

%题目二
H=[1,0,1;0,1,0;1,0,0;0,1,1;1,0,-sqrt(3)/2;0,1,-0.5];
Z=[3.1;1;2;2.1;1.1;0.4];
D=eye(6);%注意D是观测值的维度
X=inv(H'*inv(D)*H)*H'*inv(D)*Z
v=(H/(H'/D*H)*H'/D-D)*Z;
a=(v'/D*v)/3;
V2=inv(H'/D*H)*a
V1=inv(H'/D*H)

%估计坐标转换参数
Z=[-2;1;-0.9;1.1;2;2.8];
H=[1,0,0,-1;1,0,1,0;1,0,1,-1;0,1,1,0;0,1,0,1;0,1,1,1];
D=eye(6);
X=inv(H'*inv(D)*H)*H'*inv(D)*Z
v=(H/(H'/D*H)*H'/D-D)*Z;
a=v'/D*v/2;
V1=inv(H'/D*H)*a;
Dx=[1,0,1,-2]*V1*[1;0;1;-2]
Dy=[0,1,1,2]*V1*[0;1;1;2]
x4=X(1)+X(3)*1-X(4)*2;
y4=X(2)+X(3)*2+X(4);

%含约束条件的最小二乘估计P17
X0=[14;14];%近似值
W=eye(3);
for i=1:2
    H=[X0(1)/sqrt((X0(1)-0)^2+(X0(2)-10)^2),(X0(2)-10)/sqrt((X0(1)-0)^2+(X0(2)-10)^2);
       X0(1)/sqrt((X0(1)-0)^2+(X0(2)-0)^2),X0(2)/sqrt((X0(1)-0)^2+(X0(2)-0)^2);
       (X0(1)-10)/sqrt((X0(1)-10)^2+(X0(2)-0)^2),X0(2)/sqrt((X0(1)-10)^2+(X0(2)-0)^2)];
    z=[15.83-sqrt((X0(1)-0)^2+(X0(2)-10)^2);21.3-sqrt((X0(1)-0)^2+(X0(2)-0)^2);15.69-sqrt((X0(1)-10)^2+(X0(2)-0)^2)];
    %C=[X0(1)/sqrt((X0(1)-0)^2+(X0(2)-0)^2),X0(2)/sqrt((X0(1)-0)^2+(X0(2)-0)^2)];
    %p=sqrt((X0(1)-0)^2+(X0(2)-0)^2)-21.21;
    N=H'*W*H;
    %Nc=C/N*C';
    x=inv(H'*W*H)*H'*W*z;
    %x=(inv(N)-inv(N)*C'/Nc*C/N)*H'*W*z-inv(N)*C'/Nc*p;
    X=x+X0;
    X0=X;
end
%V1=0.05^2*(inv(N)-inv(N)*C'/inv(Nc)*C/N)
V1=0.05^2*inv(N);
%v=(H/(H'*W*H)*H'*W-W)*z;
v=H*x-z;
%a=(v'*W*v)/2;
a=(v'*W*v)/1;
V2=V1*a
